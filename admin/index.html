<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin ‚Äì illumina</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/main.css?v=20240916">
  <link rel="stylesheet" href="assets/css/admin.css?v=20240916">
  <style>
    /* Critical admin styles - inline fallback */
    /* Hide admin panel initially */
    .admin-panel {
      display: none !important;
    }

    /* Show admin panel only when logged in */
    .admin-container.is-logged-in .admin-panel {
      display: block !important;
      width: 100% !important;
    }

    .admin-container.is-logged-in {
      max-width: 1400px !important;
      align-items: stretch !important;
      text-align: left !important;
      width: 100% !important;
    }

    /* Hide login form when logged in */
    .admin-container.is-logged-in #admin-login {
      display: none !important;
    }

    .toolbar {
      display: flex !important;
      justify-content: space-between !important;
      align-items: center !important;
      flex-wrap: wrap !important;
      gap: 12px !important;
      margin: 20px 0 16px !important;
      padding: 16px !important;
      background: var(--surface) !important;
      border: 1px solid var(--line) !important;
      border-radius: 12px !important;
    }

    .toolbar .meta {
      display: flex !important;
      align-items: center !important;
      gap: 12px !important;
      margin: 0 !important;
    }

    .toolbar .actions {
      display: flex !important;
      gap: 8px !important;
      flex-wrap: wrap !important;
    }

    .toolbar .actions .btn {
      width: auto !important;
      padding: 8px 16px !important;
      white-space: nowrap !important;
      font-size: 14px !important;
    }

    .admin-note {
      background: rgba(123, 191, 68, 0.1) !important;
      border: 1px solid var(--primary) !important;
      border-radius: 8px !important;
      padding: 16px !important;
      margin: 16px 0 !important;
      font-size: 14px !important;
      color: var(--text) !important;
    }

    .filters {
      display: flex !important;
      gap: 12px !important;
      align-items: center !important;
      flex-wrap: wrap !important;
      margin: 16px 0 !important;
      padding: 16px !important;
      background: var(--surface) !important;
      border: 1px solid var(--line) !important;
      border-radius: 8px !important;
    }

    .filters .input {
      width: auto !important;
      min-width: 120px !important;
    }

    .filters .stat-badge {
      margin-right: 16px !important;
    }

    .charts {
      display: grid !important;
      grid-template-columns: repeat(4, 1fr) !important;
      gap: 16px !important;
      margin: 16px 0 24px !important;
    }

    .table-wrap {
      margin-top: 16px !important;
    }

    @media (max-width: 1200px) {
      .charts {
        grid-template-columns: 1fr 1fr !important;
      }
    }

    @media (max-width: 768px) {
      .charts {
        grid-template-columns: 1fr !important;
      }

      .toolbar {
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 16px !important;
      }

      .toolbar .meta,
      .toolbar .actions {
        justify-content: center !important;
      }

      .filters {
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 12px !important;
      }
    }

    /* QR Code Modal Styles */
    #qrModal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    #qrModal.show {
      display: flex;
    }

    #qrModal .modal-card {
      background: var(--surface);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
      animation: popIn 0.3s ease-out;
    }

    /* QR Code table cell styles */
    .admin-panel table td canvas {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .admin-panel table td canvas:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(123, 191, 68, 0.4);
    }
  </style>
  <meta name="description" content="Admin panel for illumina registrations.">
  <!-- Open Graph / WhatsApp / Facebook -->
  <meta property="og:site_name" content="illumina">
  <meta property="og:type" content="website">
  <meta property="og:title" content="Admin ‚Ä¢ illumina">
  <meta property="og:description" content="Admin panel for illumina registrations.">
  <meta property="og:url" content="https://lac-chess.netlify.app/admin.html">
  <meta property="og:image" content="https://lac-chess.netlify.app/images/og-image.jpg">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Admin ‚Ä¢ illumina">
  <meta name="twitter:description" content="Admin panel for illumina registrations.">
  <meta name="twitter:image" content="https://lac-chess.netlify.app/images/og-image.jpg">
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-Y0TXQST3MG"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-Y0TXQST3MG');
  </script>
  <!-- PostHog Analytics -->
  <script>
    !function (t, e) { var o, n, p, r; e.__SV || (window.posthog = e, e._i = [], e.init = function (i, s, a) { function g(t, e) { var o = e.split("."); 2 == o.length && (t = t[o[0]], e = o[1]), t[e] = function () { t.push([e].concat(Array.prototype.slice.call(arguments, 0))) } } (p = t.createElement("script")).type = "text/javascript", p.crossOrigin = "anonymous", p.async = !0, p.src = s.api_host.replace(".i.posthog.com", "-assets.i.posthog.com") + "/static/array.js", (r = t.getElementsByTagName("script")[0]).parentNode.insertBefore(p, r); var u = e; for (void 0 !== a ? u = e[a] = [] : a = "posthog", u.people = u.people || [], u.toString = function (t) { var e = "posthog"; return "posthog" !== a && (e += "." + a), t || (e += " (stub)"), e }, u.people.toString = function () { return u.toString(1) + ".people (stub)" }, o = "init Re Ms Fs Pe Rs Cs capture Ve calculateEventProperties Ds register register_once register_for_session unregister unregister_for_session zs getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSurveysLoaded onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey canRenderSurveyAsync identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty Ls As createPersonProfile Ns Is Us opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing is_capturing clear_opt_in_out_capturing Os debug I js getPageViewId captureTraceFeedback captureTraceMetric".split(" "), n = 0; n < o.length; n++)g(u, o[n]); e._i.push([i, s, a]) }, e.__SV = 1) }(document, window.posthog || []);
    posthog.init('phc_UOdKm95N8QaKxaZvW1WBPdb3AqIHOTFBgf696oExyDa', {
      api_host: 'https://us.i.posthog.com',
      defaults: '2025-05-24',
      person_profiles: 'identified_only',
    })
  </script>
</head>

<body>
  <div id="pageLoader" class="page-loader" aria-live="polite" aria-busy="true">
    <div class="spinner-standalone" aria-hidden="true"></div>
    <div id="pageLoaderText" class="loader-text">Loading‚Ä¶</div>
  </div>
  <!-- <div id="siteBanner" class="site-banner" role="region" aria-label="Announcement" style="display:none">
    <span><strong>New trial is out</strong> ‚Äî follow updates at</span>
    <a href="https://www.instagram.com/lac_cultural_department/" target="_blank" rel="noopener">@lac_cultural_department</a>
    <button id="closeBanner" class="banner-close" aria-label="Close announcement">√ó</button>
  </div> -->
  <main class="container admin-container" role="main">
    <h1 class="title">Admin</h1>

    <form id="admin-login" class="form-card" style="max-width:480px;">
      <div class="form-grid">
        <div class="form-group">
          <label for="adminUser">Username</label>
          <input id="adminUser" class="input" type="text" placeholder="admin" required>
        </div>
        <div class="form-group">
          <label for="adminPass">Password</label>
          <div class="input-row">
            <input id="adminPass" class="input" type="password" placeholder="Password" required>
            <button id="togglePass" class="btn-icon" type="button" aria-label="Show password">üëÅÔ∏è</button>
          </div>
        </div>
        <button class="btn btn-primary" type="submit">Login</button>
      </div>
    </form>

    <section id="admin-panel" class="admin-panel" style="display:none; width:100%;">
      <div class="toolbar">
        <div class="meta">
          Registrations
          <span class="live"><span id="liveDot" class="live-dot"></span>Live</span>
          <span id="statusIndicator" class="status-indicator">Connecting...</span>
          <span id="totalBadge" class="stat-badge" style="font-size:20px; padding:10px 14px; margin-left:8px;">Total: 0</span>
        </div>
        <div class="actions">
          <button id="openQuickSearch" class="btn btn-primary">Quick Search (Ctrl+K)</button>
          <input id="searchBox" class="input search" placeholder="Search name, Token No, IP..." />
          <button id="exportCsv" class="btn btn-dark">Export CSV</button>
          <button id="debugIds" class="btn btn-secondary">Debug IDs</button>
          <button id="debugEvents" class="btn btn-secondary">Debug Events</button>
          <button id="refreshEvents" class="btn btn-secondary">Refresh Events</button>
          <button id="showErrors" class="btn btn-secondary">Error Log <span id="errorCount" class="badge"
              aria-label="unread errors">0</span></button>
          <button id="runTests" class="btn btn-secondary">Run Tests</button>
          <button id="refreshData" class="btn btn-primary">Refresh</button>
          <button id="logoutBtn" class="btn btn-secondary">Logout</button>
          <a href="deleted-users.html" class="btn btn-dark" style="text-decoration:none;">üóëÔ∏è Deleted Users</a>
        </div>
      </div>
      <!-- Note removed as requested -->

      <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
        <button id="showVerificationToggle" class="btn btn-secondary">
          Show Ticket Verification
        </button>
        <a href="rsvp-management.html" class="btn btn-primary" style="text-decoration: none;">
          üé´ RSVP Management
        </a>
      </div>

      <!-- Hidden by default, can be toggled -->
      <div class="form-card" id="ticketVerificationSection" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
          <h2 style="margin:0;">Ticket Verification</h2>
          <button id="toggleVerificationSection" class="btn-icon" style="font-size:1.2em;"
            aria-label="Hide verification section">
            <span>‚àí</span>
          </button>
        </div>
        <div id="verificationContent">
          <p>Use the QR scanner to verify attendee tickets.</p>
          <a href="scan.html" class="btn btn-primary" style="margin-top: 12px; display:inline-block;">
            Open QR Scanner
          </a>
          <!-- User Details Display -->
          <div id="userDetailsCard"
            style="display: none; margin-top: 16px; padding: 20px; background: var(--bg); border: 2px solid var(--primary); border-radius: 12px;">
            <h4 style="margin: 0 0 16px; color: var(--primary);">üë§ User Details</h4>
            <div id="userDetailsContent"></div>
            <button id="closeUserDetails" class="btn btn-secondary" style="margin-top: 16px;">Close</button>
          </div>
        </div>
      </div>



      <!-- Error Log Section -->
      <div id="errorLogSection" class="error-log-section" style="display:none;">
        <h3>Error Log</h3>
        <div class="error-tabs">
          <button id="localErrorsTab" class="error-tab active">Local Errors</button>
          <button id="dbErrorsTab" class="error-tab">Database Errors</button>
        </div>
        <div class="actions" style="margin-bottom: 10px;">
          <button id="clearErrors" class="btn btn-secondary">Clear Local Errors</button>
          <button id="exportErrors" class="btn btn-dark">Export Error Log</button>
          <button id="loadDbErrors" class="btn btn-primary">Load DB Errors</button>
        </div>
        <div id="localErrorContent" class="error-log-content"></div>
        <div id="dbErrorContent" class="error-log-content" style="display:none;"></div>
      </div>
      <div class="filters">
        <label class="helper">Course</label>
        <select id="filterCourse" class="input">
          <option value="">All</option>
          <option>PUC / 12th / ISC / CBSE</option>
          <option>Degree / UG</option>
          <option>PG</option>
        </select>
        <label class="helper">Events</label>
        <input id="filterEvents" class="input" placeholder="Filter by event name‚Ä¶" />
      </div>
      <div class="charts">
        <div class="chart-card"><canvas id="byDay"></canvas></div>
        <div class="chart-card"><canvas id="byCourse"></canvas></div>
        <div class="chart-card"><canvas id="byCollege"></canvas></div>
        <div class="chart-card"><canvas id="byCoursePct"></canvas></div>
      </div>
      <div class="table-wrap">
        <div id="tableLoading" class="loading-overlay">
          <div class="spinner-standalone"></div>
        </div>
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Username</th>
              <th>Phone</th>
              <th>Course</th>
              <th>Events</th>
              <th>Payment</th>
              <th>College</th>
              <th>IP</th>
              <th>Token No</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
        <div id="emptyState" class="empty-state" style="display:none;">No results match your filter.</div>
      </div>

      <!-- Diagnostics Modal -->
      <div id="testModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="testTitle">
        <div class="modal-card success">
          <div id="testTitle" class="modal-title">Diagnostics</div>
          <div id="testSummary" class="modal-text"></div>
          <div id="testResults" class="error-log-content" style="text-align:left; max-height: 360px;"></div>
          <button id="testClose" class="btn btn-primary" type="button">Close</button>
        </div>
      </div>
    </section>
  </main>
  <br>

  <!-- <footer class="footer" role="contentinfo">
    <small>Designed by CodeCraft ‚Ä¢ <a class="login-link" href="https://www.instagram.com/lac_cultural_department/" target="_blank" rel="noopener">Instagram</a></small>
  </footer> -->

  <script src="assets/js/admin-fix.js"></script>
  <script type="module">
    // Dynamic Firestore loader so the module doesn't fail if CDN is blocked
    const FB = { loaded: false };
    async function ensureFirebase() {
      if (FB.loaded) return FB;
      try {
        const cfg = await import('../assets/js/firebase-config.js');
        const fs = await import('https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js');
        FB.db = cfg.db;
        FB.collection = fs.collection;
        FB.getDocs = fs.getDocs;
        FB.query = fs.query;
        FB.orderBy = fs.orderBy;
        FB.onSnapshot = fs.onSnapshot;
        FB.limit = fs.limit;
        FB.where = fs.where;
        FB.doc = fs.doc;
        FB.updateDoc = fs.updateDoc;
        FB.setDoc = fs.setDoc;
        FB.addDoc = fs.addDoc;
        FB.serverTimestamp = fs.serverTimestamp;
        FB.loaded = true;
      } catch (e) {
        console.error('Failed to load Firebase/Firestore dynamically', e);
        throw e;
      }
      return FB;
    }

    console.log('[ADMIN] Module loaded, waiting for user interaction‚Ä¶');
    // Quick Search modal wiring
    const quickModal = (() => {
      // Create modal in DOM once
      let el = document.getElementById('quickSearchModal');
      if (!el) {
        el = document.createElement('div');
        el.id = 'quickSearchModal';
        el.className = 'modal';
        el.setAttribute('role','dialog');
        el.setAttribute('aria-modal','true');
        el.setAttribute('aria-labelledby','quickSearchTitle');
        el.style.display = 'none';
        // Center the modal as a full-screen overlay
        el.style.position = 'fixed';
        el.style.inset = '0';
        el.style.alignItems = 'center';
        el.style.justifyContent = 'center';
        el.style.zIndex = '2000';
        el.style.background = 'rgba(0,0,0,0.6)';
        el.innerHTML = `
          <div class="modal-card">
            <div id="quickSearchTitle" class="modal-title">Quick Search</div>
            <input id="quickSearchInput" class="input" placeholder="Type name, Token, IP, phone‚Ä¶ and press Enter" style="margin-top:8px;">
            <div class="modal-actions" style="margin-top:12px; display:flex; justify-content:flex-end; gap:8px;">
              <button id="quickSearchClose" class="btn btn-secondary" type="button">Close</button>
            </div>
          </div>`;
        document.body.appendChild(el);
      }
      return el;
    })();
    const quickInput = () => document.getElementById('quickSearchInput');
    const searchBox = () => document.getElementById('searchBox');
    function openQuickSearch() {
      quickModal.style.display = 'flex';
      const qi = quickInput();
      if (qi) { qi.value = ''; qi.focus(); }
    }
    function closeQuickSearch() { quickModal.style.display = 'none'; }
    document.getElementById('openQuickSearch')?.addEventListener('click', openQuickSearch);
    document.getElementById('quickSearchClose')?.addEventListener('click', closeQuickSearch);
    quickModal?.addEventListener('click', (e) => { if (e.target === quickModal) closeQuickSearch(); });
    document.addEventListener('keydown', (e) => {
      const k = e.key.toLowerCase();
      if ((e.ctrlKey || e.metaKey) && k === 'k') { e.preventDefault(); openQuickSearch(); }
      else if (!e.ctrlKey && !e.metaKey && k === '/') { e.preventDefault(); openQuickSearch(); }
      else if (k === 'escape') { closeQuickSearch(); }
    });
    quickModal.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const qi = quickInput();
        const sb = searchBox();
        if (qi && sb) {
          sb.value = qi.value;
          sb.dispatchEvent(new Event('input', { bubbles: true }));
        }
        closeQuickSearch();
      }
    });
    // db is imported from firebase-config.js

    // Cache for event selections by user token (shortId)
    let __eventSelectionsByToken = new Map();

    async function startEventSelectionsListener() {
      try {
        console.log('[ADMIN] Starting event selections listener‚Ä¶');
        await ensureFirebase();
        const esRef = FB.collection(FB.db, 'eventSelections');
        FB.onSnapshot(esRef, (snap) => {
          const map = new Map();
          console.log(`[ADMIN] Processing ${snap.size} event selection documents`);
          
          snap.forEach(doc => {
            const d = doc.data();
            console.log('Event selection document:', doc.id, d);
            
            // Handle different possible token field names
            const userToken = d.userToken || d.tokenNo || d.shortId || d.token;
            
            if (userToken) {
              map.set(String(userToken), { id: doc.id, ...d });
              console.log(`Mapped events for token ${userToken}:`, d.selections);
            } else {
              console.warn('Event selection document missing user token:', doc.id, d);
            }
          });
          
          __eventSelectionsByToken = map;
          console.log('[ADMIN] Event selections cache updated:', map.size, 'entries');
          
          // Re-render table if we already have rows
          if (window.__lastAllRows) {
            try { 
              console.log('[ADMIN] Re-rendering table with updated event selections');
              renderWithFilters(window.__lastAllRows); 
            } catch (e) {
              console.error('Error re-rendering table:', e);
            }
          }
        }, (err) => {
          console.error('Event selections listener error:', err);
          errorLog.addError('EVENT_SEL_LISTEN_ERROR', 'Failed to listen to eventSelections', err);
        });
      } catch (e) {
        console.error('Failed to initialize event selections listener:', e);
        errorLog.addError('EVENT_SEL_INIT_ERROR', 'Could not initialize eventSelections listener', e);
      }
    }

    // Announcement banner logic
    try {
      const banner = document.getElementById('siteBanner');
      if (banner) {
        banner.style.display = 'flex';
        document.body.classList.add('with-banner');
        const h = banner.getBoundingClientRect().height;
        document.documentElement.style.setProperty('--banner-h', h + 'px');
        const btn = document.getElementById('closeBanner');
        if (btn) btn.addEventListener('click', () => {
          banner.style.display = 'none';
          document.body.classList.remove('with-banner');
        });
      }
    } catch { }

    const loginForm = document.getElementById('admin-login');
    const panel = document.getElementById('admin-panel');
    const toggleBtn = document.getElementById('togglePass');
    toggleBtn.addEventListener('click', (e) => {
      e.preventDefault();
      const input = document.getElementById('adminPass');
      const isPwd = input.type === 'password';
      input.type = isPwd ? 'text' : 'password';
      toggleBtn.setAttribute('aria-label', isPwd ? 'Hide password' : 'Show password');
      // Also flip icon for clarity
      try { toggleBtn.textContent = isPwd ? 'üôà' : 'üëÅÔ∏è'; } catch(_) {}
      try { toggleBtn.title = isPwd ? 'Hide password' : 'Show password'; } catch(_) {}
    });
    // Auto-fill if remembered and auto-login if persistent login is enabled
    const remembered = localStorage.getItem('adminRemember') === '1';
    const persistentLogin = localStorage.getItem('adminPersistentLogin') === '1';

    if (remembered) {
      document.getElementById('adminUser').value = 'admin';
      document.getElementById('adminPass').value = 'lowry@123';
    }

    // Auto-login if persistent login is enabled
    if (persistentLogin) {
      setTimeout(async () => {
        showPageLoader('Auto-signing you in‚Ä¶');
        loginForm.style.display = 'none';
        panel.style.display = '';
        const mainEl = document.querySelector('main.container.admin-container');
        if (mainEl) mainEl.classList.add('is-logged-in');
        try {
          await ensureFirebase();
          await initDataFeed();
          // Listen to event selections in real-time so Events column stays updated
          startEventSelectionsListener();

          // Start a light real-time feed for errorLogs so admins see user issues immediately
          try {
            const errRef = FB.query(FB.collection(FB.db, 'errorLogs'), FB.orderBy('timestamp', 'desc'));
            FB.onSnapshot(errRef, (snap) => {
              const list = [];
              snap.forEach(doc => list.push({ id: doc.id, ...doc.data() }));
              errorLog.dbErrors = list;
              errorLog.updateDisplay();
              const badge = document.getElementById('errorCount');
              if (badge) badge.textContent = String(errorLog.errors.length + (errorLog.dbErrors?.length || 0));
            }, (err) => {
              errorLog.addError('DB_ERROR_LISTEN', 'Failed to listen to error logs', err);
            });
          } catch (err) {
            errorLog.addError('DB_ERROR_LISTEN', 'Error setting up error log listener', err);
          }
        } catch (eInit) {
          // Initialization failed; show message and keep panel visible so user can retry refresh
          errorLog.addError('INIT_LOGIN_FAIL', 'Failed during initialization after auto-login', eInit);
          const statusIndicator = document.getElementById('statusIndicator');
          if (statusIndicator) {
            statusIndicator.textContent = 'Init Error';
            statusIndicator.className = 'status-indicator error';
          }
          alert('Could not load data. You can click Refresh to retry. See Error Log for details.');
        } finally {
          hidePageLoader();
        }
      }, 500);
    }

    // Add remember me toggle
    const rememberToggle = document.createElement('label');
    rememberToggle.className = 'helper';
    rememberToggle.style.display = 'inline-flex';
    rememberToggle.style.alignItems = 'center';
    rememberToggle.style.gap = '6px';
    rememberToggle.innerHTML = `<input id="rememberMe" type="checkbox" ${remembered ? 'checked' : ''}> Remember me`;
    loginForm.querySelector('.form-grid').appendChild(rememberToggle);

    // Add persistent login toggle
    const persistentToggle = document.createElement('label');
    persistentToggle.className = 'helper';
    persistentToggle.style.display = 'inline-flex';
    persistentToggle.style.alignItems = 'center';
    persistentToggle.style.gap = '6px';
    persistentToggle.innerHTML = `<input id="persistentLogin" type="checkbox" ${persistentLogin ? 'checked' : ''}> Stay logged in`;
    loginForm.querySelector('.form-grid').appendChild(persistentToggle);

    // Page loader helpers
    const pageLoader = document.getElementById('pageLoader');
    const pageLoaderText = document.getElementById('pageLoaderText');
    const showPageLoader = (text = 'Loading‚Ä¶') => {
      if (pageLoader) {
        if (pageLoaderText) pageLoaderText.textContent = text;
        pageLoader.classList.add('show');
      }
    };
    const hidePageLoader = () => { if (pageLoader) pageLoader.classList.remove('show'); };

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      console.log('[ADMIN] Login form submitted');
      const u = document.getElementById('adminUser').value.trim();
      const p = document.getElementById('adminPass').value;
      // Allow quick login even if form auto-capitalizes
      if (u.toLowerCase() === 'admin' && p === 'lowry@123') {
        showPageLoader('Signing you in‚Ä¶');
        console.log('[ADMIN] Credentials accepted, initializing data feed‚Ä¶');
        localStorage.setItem('adminRemember', document.getElementById('rememberMe').checked ? '1' : '0');
        localStorage.setItem('adminPersistentLogin', document.getElementById('persistentLogin').checked ? '1' : '0');
        loginForm.style.display = 'none';
        panel.style.display = '';
        const mainEl = document.querySelector('main.container.admin-container');
        if (mainEl) mainEl.classList.add('is-logged-in');
        try {
          await ensureFirebase().then(() => console.log('[ADMIN] Firestore ready')).catch((e) => { console.error('[ADMIN] Firestore init failed', e); throw e; });
          await initDataFeed();
          // Listen to event selections in real-time so Events column stays updated
          startEventSelectionsListener();
          // Start a light real-time feed for errorLogs so admins see user issues immediately
          try {
            const errRef = FB.query(FB.collection(FB.db, 'errorLogs'), FB.orderBy('timestamp', 'desc'));
            FB.onSnapshot(errRef, (snap) => {
              const list = [];
              snap.forEach(doc => list.push({ id: doc.id, ...doc.data() }));
              errorLog.dbErrors = list;
              errorLog.updateDisplay();
              const badge = document.getElementById('errorCount');
              if (badge) badge.textContent = String(errorLog.errors.length + (errorLog.dbErrors?.length || 0));
            }, (err) => {
              errorLog.addError('DB_ERROR_LISTEN', 'Failed to listen to error logs', err);
            });
          } catch (err) {
            errorLog.addError('DB_ERROR_LISTEN', 'Error setting up error log listener', err);
          }
        } catch (eInit) {
          // Initialization failed; show message and keep panel visible so user can retry refresh
          errorLog.addError('INIT_LOGIN_FAIL', 'Failed during initialization after login', eInit);
          const statusIndicator = document.getElementById('statusIndicator');
          if (statusIndicator) {
            statusIndicator.textContent = 'Init Error';
            statusIndicator.className = 'status-indicator error';
          }
          alert('Could not load data. You can click Refresh to retry. See Error Log for details.');
        } finally {
          hidePageLoader();
        }
      } else {
        alert('Invalid credentials');
      }
    });

    // Toggle ticket verification section
    const verificationSection = document.getElementById('ticketVerificationSection');
    const showVerificationToggle = document.getElementById('showVerificationToggle');
    const toggleVerificationBtn = document.getElementById('toggleVerificationSection');

    if (showVerificationToggle && verificationSection) {
      showVerificationToggle.addEventListener('click', () => {
        verificationSection.style.display = '';
        showVerificationToggle.style.display = 'none';
      });
    }

    if (toggleVerificationBtn && verificationSection) {
      toggleVerificationBtn.addEventListener('click', () => {
        verificationSection.style.display = 'none';
        if (showVerificationToggle) {
          showVerificationToggle.style.display = 'inline-block';
        }
      });
    }

    // Close user details card (for ticket verification)
    document.getElementById('closeUserDetails')?.addEventListener('click', () => {
      const card = document.getElementById('userDetailsCard');
      if (card) card.style.display = 'none';
    });

    // Manual lookup and QR scanning moved out; related functions removed to prevent runtime errors

    // Error logging system
    const errorLog = {
      errors: [],
      dbErrors: [],
      addError: function (type, message, details = null) {
        // Normalize details so UI can render meaningful info
        let det = details;
        try {
          if (details instanceof Error) {
            det = { message: details.message, stack: details.stack };
          } else if (details && typeof details === 'object' && 'message' in details && 'stack' in details) {
            det = { message: String(details.message), stack: String(details.stack) };
          }
        } catch (_) { /* noop */ }
        const error = {
          timestamp: new Date().toISOString(),
          type: type,
          message: message,
          details: det
        };
        this.errors.push(error);
        console.error(`[${type}] ${message}`, details);
        this.updateDisplay();
        this.saveToStorage();
      },
      updateDisplay: function () {
        const localContent = document.getElementById('localErrorContent');
        const dbContent = document.getElementById('dbErrorContent');

        if (localContent) {
          localContent.innerHTML = this.errors.map(error => `
            <div class="error-entry">
              <div class="error-header">
                <span class="error-time">${new Date(error.timestamp).toLocaleString()}</span>
                <span class="error-type">${error.type}</span>
              </div>
              <div class="error-message">${error.message}</div>
              ${error.details ? `<div class="error-details">${JSON.stringify(error.details, null, 2)}</div>` : ''}
            </div>
          `).join('');
        }

        if (dbContent) {
          dbContent.innerHTML = this.dbErrors.map(error => `
            <div class="error-entry">
              <div class="error-header">
                <span class="error-time">${error.timestamp?.toDate ? error.timestamp.toDate().toLocaleString() : 'Unknown'}</span>
                <span class="error-type">${error.type || 'DB_ERROR'}</span>
              </div>
              <div class="error-message">${error.message || 'Unknown error'}</div>
              ${error.details ? `<div class="error-details">${JSON.stringify(error.details, null, 2)}</div>` : ''}
            </div>
          `).join('');
        }
      },
      saveToStorage: function () {
        try {
          localStorage.setItem('adminErrorLog', JSON.stringify(this.errors.slice(-50))); // Keep last 50 errors
        } catch (e) {
          console.warn('Failed to save error log to localStorage');
        }
      },
      loadFromStorage: function () {
        try {
          const stored = localStorage.getItem('adminErrorLog');
          if (stored) {
            this.errors = JSON.parse(stored);
            this.updateDisplay();
          }
        } catch (e) {
          console.warn('Failed to load error log from localStorage');
        }
      },
      clear: function () {
        this.errors = [];
        this.updateDisplay();
        this.saveToStorage();
      },
      export: function () {
        const data = JSON.stringify(this.errors, null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `error-log-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(a.href);
      },
      loadDbErrors: async function () {
        try {
          await ensureFirebase();
          const q = FB.query(FB.collection(FB.db, 'errorLogs'), FB.orderBy('timestamp', 'desc'), FB.limit(100));
          const snap = await FB.getDocs(q);
          this.dbErrors = [];
          snap.forEach(doc => {
            this.dbErrors.push({ id: doc.id, ...doc.data() });
          });
          this.updateDisplay();
          console.log(`Loaded ${this.dbErrors.length} database errors`);
        } catch (error) {
          this.addError('DB_ERROR_LOAD', 'Failed to load database errors', error);
        }
      }
    };

    // Load error log on page load and keep unread count
    errorLog.loadFromStorage();
    function updateErrorBadge() {
      const badge = document.getElementById('errorCount');
      if (badge) badge.textContent = String(errorLog.errors.length + (errorLog.dbErrors?.length || 0));
    }
    const _addErrorRef = errorLog.addError.bind(errorLog);
    errorLog.addError = function (type, message, details) {
      _addErrorRef(type, message, details);
      updateErrorBadge();
    };
    updateErrorBadge();

    let unsubscribe = null;
    let connectionRetries = 0;
    const maxRetries = 3;

    async function initDataFeed() {
      console.log('[ADMIN] initDataFeed() start');
      const tbody = document.getElementById('rows');
      const statusIndicator = document.getElementById('statusIndicator');

      tbody.innerHTML = '';
      document.getElementById('tableLoading').classList.add('show');
      document.getElementById('liveDot').classList.remove('on');

      // Update status
      if (statusIndicator) {
        statusIndicator.textContent = 'Connecting...';
        statusIndicator.className = 'status-indicator loading';
      }

      try {
        // Test database connection first
        await ensureFirebase();
        const testQuery = FB.query(FB.collection(FB.db, 'registrations'), FB.limit(1));
        await FB.getDocs(testQuery);

        let qRef;
        try {
          qRef = FB.query(FB.collection(FB.db, 'registrations'), FB.orderBy('createdAt', 'desc'));
        } catch (e) {
          errorLog.addError('QUERY_ERROR', 'Failed to create ordered query, using basic query', e);
          qRef = FB.collection(FB.db, 'registrations');
        }

        if (unsubscribe) unsubscribe();

        unsubscribe = FB.onSnapshot(qRef, (snap) => {
          try {
            const rows = [];
            snap.forEach(doc => {
              try {
                const data = doc.data();
                rows.push({ id: doc.id, ...data });
              } catch (docError) {
                errorLog.addError('DOC_PARSE_ERROR', `Failed to parse document ${doc.id}`, docError);
              }
            });

            renderWithFilters(rows);
            document.getElementById('tableLoading').classList.remove('show');
            document.getElementById('liveDot').classList.add('on');
            connectionRetries = 0; // Reset retry counter on success

            // Update status
            if (statusIndicator) {
              statusIndicator.textContent = `Connected (${rows.length} records)`;
              statusIndicator.className = 'status-indicator connected';
            }

            console.log('[ADMIN] Live snapshot received; rows:', rows.length);

          } catch (renderError) {
            errorLog.addError('RENDER_ERROR', 'Failed to render data', renderError);
            document.getElementById('tableLoading').classList.remove('show');

            if (statusIndicator) {
              statusIndicator.textContent = 'Render Error';
              statusIndicator.className = 'status-indicator error';
            }
          }
        }, (err) => {
          connectionRetries++;
          errorLog.addError('CONNECTION_ERROR', `Database connection failed (attempt ${connectionRetries}/${maxRetries})`, err);

          document.getElementById('tableLoading').classList.remove('show');
          document.getElementById('liveDot').classList.remove('on');

          // Update status
          if (statusIndicator) {
            statusIndicator.textContent = `Connection Error (${connectionRetries}/${maxRetries})`;
            statusIndicator.className = 'status-indicator error';
          }

          if (connectionRetries < maxRetries) {
            // Retry after delay
            setTimeout(() => {
              errorLog.addError('RETRY', `Retrying connection... (${connectionRetries}/${maxRetries})`);
              initDataFeed();
            }, 2000 * connectionRetries); // Exponential backoff
          } else {
            errorLog.addError('FATAL_ERROR', 'Max retries reached. Please check your connection and refresh the page.');
            alert('Failed to connect to database after multiple attempts. Check the error log for details.');
          }
        });

      } catch (initialError) {
        errorLog.addError('INIT_ERROR', 'Failed to initialize data feed', initialError);
        document.getElementById('tableLoading').classList.remove('show');

        if (statusIndicator) {
          statusIndicator.textContent = 'Init Error';
          statusIndicator.className = 'status-indicator error';
        }

        alert('Failed to initialize database connection. Check the error log for details.');
      }
    }

    function renderWithFilters(all) {
      try {
        const tbody = document.getElementById('rows');
        if (!tbody) {
          errorLog.addError('RENDER_ERROR', 'Table body element not found');
          return;
        }

        // Ensure consistent recent-first ordering even if backend ordering fails
        const ordered = [...all].sort((a, b) => {
          try {
            const aT = a.createdAt?.toMillis ? a.createdAt.toMillis() : 0;
            const bT = b.createdAt?.toMillis ? b.createdAt.toMillis() : 0;
            return bT - aT; // recent first
          } catch (sortError) {
            errorLog.addError('SORT_ERROR', 'Failed to sort data by timestamp', sortError);
            return 0;
          }
        });

        const fc = document.getElementById('filterCourse')?.value || '';
        const fy = '';
        const q = document.getElementById('searchBox')?.value?.trim().toLowerCase() || '';
        const fe = document.getElementById('filterEvents')?.value?.trim().toLowerCase() || '';

        const filtered = ordered.filter(r => {
          try {
            if (!r || typeof r !== 'object') return true;
            // Exclude soft-deleted records
            if (r.deleted === true) return false;
            const course = r.course || '';
            const yearStr = r.year != null ? String(r.year) : '';
            const username = (r.username != null ? String(r.username) : '').toLowerCase();
            const token = (r.shortId != null ? String(r.shortId) : 'N/A').toLowerCase();
            const ip = (r.ip != null ? String(r.ip) : '').toLowerCase();
            const okCourse = fc ? course === fc : true;
            const okYear = fy ? yearStr === fy : true;
            const okQuery = q ? (username.includes(q) || token.includes(q) || ip.includes(q)) : true;

            // Build events text for event filter
            let eventsText = '';
            try {
              let eventsArray = [];
              if (r.eventSelections && Array.isArray(r.eventSelections) && r.eventSelections.length > 0) {
                eventsArray = r.eventSelections;
              } else if (r.shortId && __eventSelectionsByToken && __eventSelectionsByToken.has(String(r.shortId))) {
                const es = __eventSelectionsByToken.get(String(r.shortId));
                if (es && Array.isArray(es.selections)) eventsArray = es.selections;
              } else if (r.events && Array.isArray(r.events)) {
                eventsArray = r.events;
              } else if (r.selectedEvents && Array.isArray(r.selectedEvents)) {
                eventsArray = r.selectedEvents;
              }
              if (eventsArray.length > 0) {
                eventsText = eventsArray.map(ev => (ev?.eventTitle || ev?.eventId || ev?.name || ev?.title || String(ev))).join(', ').toLowerCase();
              }
            } catch(_) {}
            const okEvents = fe ? eventsText.includes(fe) : true;

            return okCourse && okYear && okQuery && okEvents;
          } catch (filterError) {
            // Use optional chaining and avoid throwing inside logger
            const idSafe = (r && (r.id || r.shortId)) ? String(r.id || r.shortId) : 'unknown';
            errorLog.addError('FILTER_ERROR', `Failed to filter record: ${idSafe}`, filterError);
            return true; // Include problematic records
          }
        });

        const totalBadge = document.getElementById('totalBadge');
        if (totalBadge) totalBadge.textContent = `Total: ${filtered.length}`;

        tbody.innerHTML = '';
        let idx = 1;
        const byCourse = { 'PUC / 12th / ISC / CBSE': 0, 'Degree / UG': 0, 'PG': 0 };
        const byCollege = {};
        // Track events for events chart (replaces college chart)
        const byEvent = {};

        filtered.forEach(d => {
          try {
            const tr = document.createElement('tr');
            const created = d.createdAt?.toDate ? d.createdAt.toDate().toLocaleString() : '';
            const shortIdDisplay = d.shortId || 'N/A';

            // Format event selections for display
            let eventsDisplay = '‚Äî';
            let eventsArray = [];
            let eventSource = 'none';
            
            try {
              // First check if events are stored directly in the registration document
              if (d.eventSelections && Array.isArray(d.eventSelections) && d.eventSelections.length > 0) {
                eventsArray = d.eventSelections;
                eventSource = 'registration.eventSelections';
              } 
              // Then check if events are stored in the separate eventSelections collection
              else if (d.shortId && __eventSelectionsByToken && __eventSelectionsByToken.has(String(d.shortId))) {
                const es = __eventSelectionsByToken.get(String(d.shortId));
                if (es && Array.isArray(es.selections)) {
                  eventsArray = es.selections;
                  eventSource = 'eventSelections.selections';
                }
              }
              // Also check for legacy event storage formats
              else if (d.events && Array.isArray(d.events)) {
                eventsArray = d.events;
                eventSource = 'registration.events';
              }
              else if (d.selectedEvents && Array.isArray(d.selectedEvents)) {
                eventsArray = d.selectedEvents;
                eventSource = 'registration.selectedEvents';
              }

              if (eventsArray.length > 0) {
                const eventsList = eventsArray.map(ev => {
                  try {
                    // Handle different event object formats
                    const eventName = ev.eventTitle || ev.eventId || ev.name || ev.title || ev;
                    const quantity = ev.quantity ? ` (${ev.quantity})` : '';
                    return `${eventName}${quantity}`;
                  } catch (evError) {
                    console.warn('Error processing event:', ev, evError);
                    return 'Invalid Event';
                  }
                }).join(', ');
                // Increment event counts for chart
                try {
                  eventsArray.forEach(ev => {
                    const name = (ev && (ev.eventTitle || ev.eventId || ev.name || ev.title)) ? (ev.eventTitle || ev.eventId || ev.name || ev.title) : String(ev);
                    const key = String(name).trim() || 'Unknown';
                    byEvent[key] = (byEvent[key] || 0) + (ev && ev.quantity ? Number(ev.quantity) || 1 : 1);
                  });
                } catch (_) {}
                // Make events fully visible by allowing wrapping
                eventsDisplay = `<div title="${eventsList} (Source: ${eventSource})" style="max-width: 420px; white-space: normal; overflow-wrap: anywhere;">${eventsList}</div>`;
              } else if (d.shortId) {
                // Show that we're looking for events but haven't found any
                eventsDisplay = `<div title="No events found for token ${d.shortId}" style="color: var(--muted); font-style: italic;">No events</div>`;
              }
            } catch (eventError) {
              console.error('Error processing events for user:', d.username, eventError);
              eventsDisplay = `<div title="Error loading events" style="color: var(--error);">Error</div>`;
            }

            const actionsHtml = `<button class="btn btn-secondary btn-sm" data-action="delete" data-id="${d.id}" aria-label="Delete user">Delete</button>`;
            tr.innerHTML = `<td>${idx++}</td><td>${escapeHtml(d.username || '')}</td><td>${escapeHtml(d.phone || '‚Äî')}</td><td>${escapeHtml(d.course || '')}</td><td>${eventsDisplay}</td><td>${escapeHtml(d.paymentMode || '‚Äî')}</td><td>${escapeHtml(d.college || '')}</td><td>${escapeHtml(d.ip || '')}</td><td>${escapeHtml(shortIdDisplay)}</td><td>${created}</td><td>${actionsHtml}</td>`;

            tbody.appendChild(tr);

            const cKey = d.course || 'Other';
            if (byCourse.hasOwnProperty(cKey)) {
              byCourse[cKey]++;
            } else {
              byCourse['Other'] = (byCourse['Other'] || 0) + 1;
            }
            // Track colleges (legacy; not used for chart anymore)
            const college = d.college || 'Unknown';
            byCollege[college] = (byCollege[college] || 0) + 1;
          } catch (rowError) {
            errorLog.addError('ROW_ERROR', `Failed to render row for record: ${d.id || 'unknown'}`, rowError);
          }
        });

        try {
          // Pass events map to charts in place of college map
          renderCharts(byCourse, byEvent);
        } catch (chartError) {
          errorLog.addError('CHART_ERROR', 'Failed to render charts', chartError);
        }

        // Save last dataset for re-render on filter change
        window.__lastAllRows = all;

        const emptyState = document.getElementById('emptyState');
        if (emptyState) emptyState.style.display = filtered.length ? 'none' : '';

        // Wire up actions after rendering
        try {
          tbody.querySelectorAll('button[data-action="delete"]').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              const id = e.currentTarget.getAttribute('data-id');
              if (!id) return;
              try {
                const pass = prompt('Enter admin delete password to soft-delete this user');
                const normalized = (pass || '').trim().replace(/'+$/,'');
                if (normalized !== '7760') {
                  alert('Incorrect password. Deletion cancelled.');
                  return;
                }
                const rec = all.find(x => x.id === id);
                if (!rec) { alert('Record not found.'); return; }
                console.log('[ADMIN] Soft-delete request', { id, username: rec?.username, shortId: rec?.shortId });
                await softDeleteUser(id, rec);
                alert('User moved to Deleted Users.');
              } catch (err) {
                errorLog.addError('DELETE_ERROR', 'Failed to delete user', err);
                const msg = (err && (err.message || err.code)) ? (err.message || err.code) : 'Unknown error';
                alert('Failed to delete user. ' + msg);
              }
            });
          });
        } catch (wireErr) {
          errorLog.addError('ACTION_WIRE_ERROR', 'Failed to wire action buttons', wireErr);
        }

      } catch (renderError) {
        errorLog.addError('RENDER_ERROR', 'Failed to render data table', renderError);
      }
    }

    document.getElementById('filterCourse').addEventListener('change', () => {
      if (window.__lastAllRows) renderWithFilters(window.__lastAllRows);
    });

    document.getElementById('searchBox').addEventListener('input', () => {
      if (window.__lastAllRows) renderWithFilters(window.__lastAllRows);
    });
    document.getElementById('filterEvents').addEventListener('input', () => {
      if (window.__lastAllRows) renderWithFilters(window.__lastAllRows);
    });

    let __courseChart = null, __yearChart = null, __coursePctChart = null;
    let __byDayChart = null;
    async function renderCharts(byCourse, byEvents) {
      const { Chart } = await import('https://cdn.jsdelivr.net/npm/chart.js@4.4.3/auto/+esm');
      const bd = document.getElementById('byDay');
      const cc = document.getElementById('byCourse');
      const cy = document.getElementById('byCollege');
      const cp = document.getElementById('byCoursePct');
      // Color palettes
      const courseColorMap = {
        'PUC / 12th / ISC / CBSE': '#4dabf7',
        'Degree / UG': '#845ef7',
        'PG': '#ffa94d',
        'Other': '#adb5bd'
      };
      const courseLabels = Object.keys(byCourse);
      const courseColors = courseLabels.map(l => courseColorMap[l] || '#74c0fc');
      const courseConfig = {
        type: 'bar',
        data: {
          labels: courseLabels,
          datasets: [{
            label: 'By Course',
            data: Object.values(byCourse),
            backgroundColor: courseColors,
            borderColor: courseColors,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true, position: 'bottom', labels: { color: '#fff' } },
            tooltip: { intersect: false, mode: 'index' }
          },
          scales: {
            x: { ticks: { color: '#B3B3B3' }, grid: { color: '#31302F', drawBorder: false } },
            y: { ticks: { color: '#B3B3B3', precision: 0 }, grid: { color: '#31302F', drawBorder: false }, beginAtZero: true }
          }
        }
      };
      // Recent activity by day (last 14 days) from window.__lastAllRows
      try {
        if (bd) {
          const all = window.__lastAllRows || [];
          const map = new Map();
          const now = new Date();
          for (let i = 13; i >= 0; i--) {
            const d = new Date(now);
            d.setDate(now.getDate() - i);
            const key = d.toISOString().slice(0, 10);
            map.set(key, 0);
          }
          all.forEach(r => {
            const t = r.createdAt?.toDate ? r.createdAt.toDate() : null;
            if (!t) return;
            const key = t.toISOString().slice(0, 10);
            if (map.has(key)) map.set(key, map.get(key) + 1);
          });
          const labels = Array.from(map.keys());
          const values = Array.from(map.values());
          const byDayConfig = {
            type: 'line',
            data: { labels, datasets: [{ label: 'Registrations (14d)', data: values, borderColor: '#7bbf44', backgroundColor: 'rgba(123,191,68,0.2)', tension: 0.3, fill: true }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'bottom', labels: { color: '#fff' } } }, scales: { x: { ticks: { color: '#B3B3B3' }, grid: { color: '#31302F', drawBorder: false } }, y: { ticks: { color: '#B3B3B3', precision: 0 }, grid: { color: '#31302F', drawBorder: false }, beginAtZero: true } } }
          };
          if (__byDayChart) __byDayChart.destroy();
          bd.parentElement.style.height = '320px';
          __byDayChart = new Chart(bd, byDayConfig);
        }
      } catch (e) {
        errorLog.addError('CHART_ERROR', 'Failed to render recent activity chart', e);
      }

      if (__courseChart) __courseChart.destroy();
      // Ensure container height for maintainAspectRatio: false
      cc.parentElement.style.height = '320px';
      __courseChart = new Chart(cc, courseConfig);

      // Build Events chart (replacing the old college chart)
      const eventEntries = Object.entries(byEvents || {}).sort((a,b) => b[1]-a[1]).slice(0, 12);
      const eventLabels = eventEntries.map(e => e[0]);
      const eventValues = eventEntries.map(e => e[1]);
      const eventColors = ['#4dabf7', '#ffa94d', '#e64980', '#495057', '#74c0fc', '#69db7c', '#ffd43b', '#ff8cc8', '#91a7ff', '#ffc9c9', '#38d9a9', '#fcc419'];

      const eventsConfig = {
        type: 'bar',
        data: {
          labels: eventLabels,
          datasets: [{
            label: 'By Event',
            data: eventValues,
            backgroundColor: eventColors.slice(0, eventLabels.length),
            borderColor: eventColors.slice(0, eventLabels.length),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true, position: 'bottom', labels: { color: '#fff', usePointStyle: true, padding: 14 } },
            tooltip: { intersect: false, mode: 'index' }
          },
          scales: {
            x: { ticks: { color: '#B3B3B3' }, grid: { color: '#31302F', drawBorder: false } },
            y: { ticks: { color: '#B3B3B3', precision: 0 }, grid: { color: '#31302F', drawBorder: false }, beginAtZero: true }
          }
        }
      };
      if (__yearChart) __yearChart.destroy();
      cy.parentElement.style.height = '320px';
      __yearChart = new Chart(cy, eventsConfig);

      // Percentage by course
      const totalCount = (byCourse['PUC / 12th / ISC / CBSE'] || 0) + (byCourse['Degree / UG'] || 0) + (byCourse['PG'] || 0);
      const pctData = totalCount > 0 ? [byCourse['PUC / 12th / ISC / CBSE'] || 0, byCourse['Degree / UG'] || 0, byCourse['PG'] || 0] : [0, 0, 0];
      const pctColors = ['#4dabf7', '#845ef7', '#ffa94d'];
      const pctConfig = {
        type: 'pie',
        data: {
          labels: ['PUC / 12th / ISC / CBSE', 'Degree / UG', 'PG'],
          datasets: [{ data: pctData, backgroundColor: pctColors, borderColor: '#1f1f1f', borderWidth: 2 }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true, position: 'bottom', labels: { color: '#fff', usePointStyle: true } },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const value = ctx.parsed || 0;
                  const pct = totalCount ? ((value / totalCount) * 100).toFixed(1) : '0.0';
                  return `${ctx.label}: ${value} (${pct}%)`;
                }
              }
            }
          }
        }
      };
      if (__coursePctChart) __coursePctChart.destroy();
      cp.parentElement.style.height = '320px';
      __coursePctChart = new Chart(cp, pctConfig);
    }

    document.getElementById('exportCsv').addEventListener('click', async () => {
      try {
        showPageLoader('Exporting data...');
        await ensureFirebase();
        const q = FB.query(FB.collection(FB.db, 'registrations'), FB.orderBy('createdAt', 'desc'));
        const snap = await FB.getDocs(q);
        const rows = [['#', 'Username', 'Phone', 'Course', 'Events', 'Payment', 'College', 'IP', 'Token No', 'Created At']];
        let i = 1;
        
        // Create an array to store promises for RSVP status checks
        const rsvpPromises = [];
        const docData = [];
        
        snap.forEach(doc => {
          const d = doc.data();
          // Skip soft-deleted users from export
          if (d && d.deleted === true) return;
          docData.push(d);
        });

        // Build CSV rows with events
        docData.forEach((d, index) => {
          // Format events for CSV
          let eventsList = '';
          try {
            let eventsArray = [];
            if (d.eventSelections && Array.isArray(d.eventSelections) && d.eventSelections.length > 0) {
              eventsArray = d.eventSelections;
            } else if (d.shortId && __eventSelectionsByToken && __eventSelectionsByToken.has(String(d.shortId))) {
              const es = __eventSelectionsByToken.get(String(d.shortId));
              if (es && Array.isArray(es.selections)) {
                eventsArray = es.selections;
              }
            } else if (d.events && Array.isArray(d.events)) {
              eventsArray = d.events;
            } else if (d.selectedEvents && Array.isArray(d.selectedEvents)) {
              eventsArray = d.selectedEvents;
            }

            if (eventsArray.length > 0) {
              eventsList = eventsArray.map(ev => {
                const eventName = ev.eventTitle || ev.eventId || ev.name || ev.title || ev;
                const quantity = ev.quantity ? ` (${ev.quantity})` : '';
                return `"${eventName}${quantity}"`;
              }).join('; ');
            }
          } catch (eventError) {
            console.error('Error processing events for CSV:', d.username, eventError);
            eventsList = 'Error';
          }

          const created = d.createdAt?.toDate ? d.createdAt.toDate().toLocaleString() : '';
          rows.push([
            i++,
            `"${(d.username || '').replace(/"/g, '""')}"`,
            `"${(d.phone || '').replace(/"/g, '""')}"`,
            `"${(d.course || '').replace(/"/g, '""')}"`,
            eventsList,
            `"${(d.paymentMode || '').replace(/"/g, '""')}"`,
            `"${(d.college || '').replace(/"/g, '""')}"`,
            `"${(d.ip || '').replace(/"/g, '""')}"`,
            `"${(d.shortId || 'N/A').replace(/"/g, '""')}"`,
            `"${created.replace(/"/g, '""')}"`
          ]);
        });

        const csv = rows.map(r => r.join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `illumina-registrations-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(a.href);

        console.log(`Successfully exported ${docData.length} registrations to CSV`);

      } catch (error) {
        errorLog.addError('CSV_EXPORT_ERROR', 'Failed to export CSV', error);
        alert('Failed to export CSV. Check the error log for details.');
      } finally {
        hidePageLoader();
      }
    });

    document.getElementById('debugIds').addEventListener('click', async () => {
      try {
        await ensureFirebase();
        const q = FB.query(FB.collection(FB.db, 'registrations'), FB.orderBy('createdAt', 'desc'));
        const snap = await FB.getDocs(q);
        const issues = [];
        const shortIdCounts = {};

        snap.forEach(doc => {
          const d = doc.data();
          const shortId = d.shortId || 'N/A';

          // Count shortId occurrences
          shortIdCounts[shortId] = (shortIdCounts[shortId] || 0) + 1;

          // Check for potential issues
          if (shortId === 'N/A') {
            issues.push(`Missing token for ${d.username} (${d.studentId})`);
          }
        });

        // Find duplicates
        Object.entries(shortIdCounts).forEach(([id, count]) => {
          if (count > 1 && id !== 'N/A') {
            issues.push(`Duplicate token ${id} found ${count} times`);
          }
        });

        if (issues.length === 0) {
          alert('No token issues found! All registrations have unique tokens.');
        } else {
          alert('Token Issues Found:\n\n' + issues.join('\n'));
        }

        console.log('Token distribution:', shortIdCounts);
      } catch (error) {
        errorLog.addError('DEBUG_ERROR', 'Failed to debug IDs', error);
        alert('Failed to debug IDs. Check the error log for details.');
      }
    });

    document.getElementById('debugEvents').addEventListener('click', async () => {
      try {
        showPageLoader('Debugging events...');
        const result = await window.debugEventSelections();
        
        let message = `Event Debug Results:\n\n`;
        message += `Registrations checked: ${result.registrationsChecked || 0}\n`;
        message += `Event selections found: ${result.eventSelectionsFound || 0}\n`;
        message += `Cache size: ${result.cacheSize || 0}\n\n`;
        
        if (result.error) {
          message += `Error: ${result.error}`;
        } else {
          message += `Check browser console for detailed logs.`;
        }
        
        alert(message);
      } catch (error) {
        errorLog.addError('DEBUG_EVENTS_ERROR', 'Failed to debug events', error);
        alert('Failed to debug events. Check the error log for details.');
      } finally {
        hidePageLoader();
      }
    });

    document.getElementById('refreshEvents').addEventListener('click', async () => {
      try {
        showPageLoader('Refreshing event data...');
        
        // Restart the event selections listener
        console.log('Manually refreshing event selections...');
        startEventSelectionsListener();
        
        // Force re-render of the table
        if (window.__lastAllRows) {
          renderWithFilters(window.__lastAllRows);
        }
        
        setTimeout(() => {
          hidePageLoader();
          alert('Event data refreshed! Check the Events column for updates.');
        }, 2000);
        
      } catch (error) {
        errorLog.addError('REFRESH_EVENTS_ERROR', 'Failed to refresh events', error);
        alert('Failed to refresh events. Check the error log for details.');
        hidePageLoader();
      }
    });

    // Error log button handlers
    document.getElementById('showErrors').addEventListener('click', () => {
      const errorSection = document.getElementById('errorLogSection');
      if (errorSection) {
        errorSection.style.display = errorSection.style.display === 'none' ? 'block' : 'none';
      }
    });

    document.getElementById('clearErrors').addEventListener('click', () => {
      if (confirm('Are you sure you want to clear all local errors?')) {
        errorLog.clear();
      }
    });

    document.getElementById('exportErrors').addEventListener('click', () => {
      errorLog.export();
    });

    document.getElementById('loadDbErrors').addEventListener('click', async () => {
      await errorLog.loadDbErrors();
      const badge = document.getElementById('errorCount');
      if (badge) badge.textContent = String(errorLog.errors.length + (errorLog.dbErrors?.length || 0));
    });

    // Error tab switching
    document.getElementById('localErrorsTab').addEventListener('click', () => {
      document.getElementById('localErrorsTab').classList.add('active');
      document.getElementById('dbErrorsTab').classList.remove('active');
      document.getElementById('localErrorContent').style.display = 'block';
      document.getElementById('dbErrorContent').style.display = 'none';
    });

    document.getElementById('dbErrorsTab').addEventListener('click', () => {
      document.getElementById('dbErrorsTab').classList.add('active');
      document.getElementById('localErrorsTab').classList.remove('active');
      document.getElementById('dbErrorContent').style.display = 'block';
      document.getElementById('localErrorContent').style.display = 'none';
    });

    // Refresh data button
    document.getElementById('refreshData').addEventListener('click', async () => {
      try {
        errorLog.addError('REFRESH', 'Manual refresh initiated');
        connectionRetries = 0; // Reset retry counter
        await initDataFeed();
      } catch (error) {
        errorLog.addError('REFRESH_ERROR', 'Failed to refresh data', error);
        alert('Failed to refresh data. Check the error log for details.');
      }
    });

    // Logout button
    document.getElementById('logoutBtn').addEventListener('click', () => {
      if (confirm('Are you sure you want to logout?')) {
        // Clear persistent login
        localStorage.setItem('adminPersistentLogin', '0');
        // Optionally clear remember me as well
        localStorage.setItem('adminRemember', '0');

        // Hide admin panel and show login form
        panel.style.display = 'none';
        loginForm.style.display = '';
        const mainEl = document.querySelector('main.container.admin-container');
        if (mainEl) mainEl.classList.remove('is-logged-in');

        // Clear form
        document.getElementById('adminUser').value = '';
        document.getElementById('adminPass').value = '';
        document.getElementById('rememberMe').checked = false;
        document.getElementById('persistentLogin').checked = false;

        // Stop any active listeners
        if (unsubscribe) {
          unsubscribe();
          unsubscribe = null;
        }
      }
    });



    // Diagnostics runner
    const testModal = document.getElementById('testModal');
    const testSummary = document.getElementById('testSummary');
    const testResults = document.getElementById('testResults');
    document.getElementById('testClose').addEventListener('click', () => testModal.classList.remove('show'));
    testModal.addEventListener('click', (e) => { if (e.target === testModal) testModal.classList.remove('show'); });
    document.getElementById('runTests').addEventListener('click', async () => {
      const tasks = [];
      const add = (name, fn) => tasks.push({ name, fn });
      const log = [];
      const pass = (name, detail = 'OK') => log.push({ name, status: 'PASS', detail });
      const fail = (name, error) => log.push({ name, status: 'FAIL', detail: (error && (error.message || String(error))) || 'Unknown error' });

      // Prepare tests (read-only and lightweight writes)
      add('Network online', async () => {
        if (navigator.onLine) pass('Network online'); else throw new Error('Offline');
      });
      add('Firestore read (registrations, 1 doc)', async () => {
        await ensureFirebase();
        const q1 = FB.query(FB.collection(FB.db, 'registrations'), FB.limit(1));
        const s1 = await FB.getDocs(q1);
        pass('Firestore read (registrations, 1 doc)', `Docs: ${s1.size}`);
      });
      add('Firestore listener (registrations)', async () => {
        await new Promise((resolve, reject) => {
          ensureFirebase().then(() => {
            const unsub = FB.onSnapshot(FB.query(FB.collection(FB.db, 'registrations'), FB.limit(1)), () => {
              try { unsub(); pass('Firestore listener (registrations)'); resolve(); } catch (e) { reject(e); }
            }, (err) => reject(err));
            setTimeout(() => { try { unsub(); } catch (_) { }; resolve(); }, 1200); // soft-timeout ok
          }).catch(reject);
        });
      });
      add('Error logs read (latest)', async () => {
        await ensureFirebase();
        const q2 = FB.query(FB.collection(FB.db, 'errorLogs'), FB.orderBy('timestamp', 'desc'), FB.limit(1));
        const s2 = await FB.getDocs(q2);
        pass('Error logs read (latest)', `Docs: ${s2.size}`);
      });
      add('Charts render', async () => {
        try {
          await renderCharts({ BBA: 0, BCA: 0, BCOM: 0, Other: 0 }, { '1': 0, '2': 0, '3': 0, Other: 0 });
          pass('Charts render');
        } catch (e) { throw e; }
      });

      // Execute tests
      for (const t of tasks) {
        try { await t.fn(); } catch (e) { fail(t.name, e); }
      }
      const failed = log.filter(x => x.status === 'FAIL').length;
      const summary = `${log.length - failed}/${log.length} checks passed`;
      testSummary.textContent = summary;
      testResults.innerHTML = log.map(e => `
        <div class="error-entry">
          <div class="error-header"><span class="error-type" style="background:${e.status === 'PASS' ? '#2f9e44' : '#d0021b'}">${e.status}</span> <span class="error-time">${e.name}</span></div>
          <div class="error-message">${e.detail}</div>
        </div>
      `).join('');
      testModal.classList.add('show');
    });

    // QR Code generation functions
    async function generateAdminQRCode(tokenNo, userName, canvas) {
      try {
        // Import QRCode library dynamically
        const QRCode = await import('https://cdn.jsdelivr.net/npm/qrcode@1.5.3/+esm');

        // Create verification payload
        const payload = JSON.stringify({
          type: 'ILLUMINA_ticket',
          token: tokenNo,
          name: userName,
          event: 'ILLUMINA 2K25',
          date: 'September 25, 2025',
          venue: 'Lowry Adventist College, Bangalore',
          ts: Date.now()
        });

        // Generate QR code on the provided canvas
        await QRCode.default.toCanvas(canvas, payload, {
          width: 60,
          margin: 1,
          errorCorrectionLevel: 'M',
          color: {
            dark: '#7bbf44',  // Green color for QR code
            light: '#ffffff'  // White background
          }
        });
      } catch (error) {
        console.error('Failed to generate QR code:', error);
        // Fallback: draw a simple placeholder
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#f0f0f0';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#666';
        ctx.font = '10px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('QR', canvas.width / 2, canvas.height / 2 + 3);
      }
    }

    // Show enlarged QR code in modal
    function showEnlargedQR(tokenNo, userName) {
      // Create modal if it doesn't exist
      let qrModal = document.getElementById('qrModal');
      if (!qrModal) {
        qrModal = document.createElement('div');
        qrModal.id = 'qrModal';
        qrModal.className = 'modal';
        qrModal.innerHTML = `
          <div class="modal-card" style="max-width: 400px; text-align: center;">
            <h3 style="color: var(--primary); margin-bottom: 16px;">üé´ User QR Code</h3>
            <div style="background: var(--bg); padding: 20px; border-radius: 12px; margin-bottom: 16px;">
              <canvas id="enlargedQRCanvas" style="border: 2px solid var(--primary); border-radius: 8px;"></canvas>
            </div>
            <div style="margin-bottom: 16px;">
              <div style="font-weight: 600; color: var(--text);">Token: ${tokenNo}</div>
              <div style="color: var(--muted); font-size: 14px;">${userName}</div>
            </div>
            <button id="closeQRModal" class="btn btn-secondary">Close</button>
          </div>
        `;
        document.body.appendChild(qrModal);

        // Add close functionality
        qrModal.addEventListener('click', (e) => {
          if (e.target === qrModal) qrModal.classList.remove('show');
        });
        document.getElementById('closeQRModal').addEventListener('click', () => {
          qrModal.classList.remove('show');
        });
      }

      // Update modal content
      const tokenDiv = qrModal.querySelector('div[style*="font-weight: 600"]');
      const nameDiv = qrModal.querySelector('div[style*="color: var(--muted)"]');
      if (tokenDiv) tokenDiv.textContent = `Token: ${tokenNo}`;
      if (nameDiv) nameDiv.textContent = userName;

      // Generate enlarged QR code
      const enlargedCanvas = document.getElementById('enlargedQRCanvas');
      if (enlargedCanvas) {
        enlargedCanvas.width = 200;
        enlargedCanvas.height = 200;
        generateEnlargedQRCode(tokenNo, userName, enlargedCanvas);
      }

      // Show modal
      qrModal.classList.add('show');
    }

    async function generateEnlargedQRCode(tokenNo, userName, canvas) {
      try {
        const QRCode = await import('https://cdn.jsdelivr.net/npm/qrcode@1.5.3/+esm');

        const payload = JSON.stringify({
          type: 'ILLUMINA_ticket',
          token: tokenNo,
          name: userName,
          event: 'ILLUMINA 2K25',
          date: 'September 25, 2025',
          venue: 'Lowry Adventist College, Bangalore',
          ts: Date.now()
        });

        await QRCode.default.toCanvas(canvas, payload, {
          width: 200,
          margin: 2,
          errorCorrectionLevel: 'M',
          color: {
            dark: '#7bbf44',
            light: '#ffffff'
          }
        });
      } catch (error) {
        console.error('Failed to generate enlarged QR code:', error);
        const ctx = canvas.getContext('2d');
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('QR Code', canvas.width / 2, canvas.height / 2);
        ctx.fillText('Error', canvas.width / 2, canvas.height / 2 + 20);
      }
    }

    // Debug function to check event selections
    window.debugEventSelections = async function() {
      console.log('=== Debugging Event Selections ===');
      try {
        // Check registrations collection for event data
        console.log('Checking registrations collection...');
        await ensureFirebase();
        const regQuery = FB.query(FB.collection(FB.db, 'registrations'), FB.limit(5));
        const regSnap = await FB.getDocs(regQuery);

        regSnap.forEach(doc => {
          const data = doc.data();
          console.log(`Registration ${doc.id}:`, {
            username: data.username,
            shortId: data.shortId,
            eventSelections: data.eventSelections,
            events: data.events,
            selectedEvents: data.selectedEvents
          });
        });

        // Check eventSelections collection
        console.log('Checking eventSelections collection...');
        const esQuery = query(collection(db, 'eventSelections'), limit(10));
        const esSnap = await getDocs(esQuery);

        console.log(`Found ${esSnap.size} event selection documents`);
        esSnap.forEach(doc => {
          const data = doc.data();
          console.log(`Event Selection ${doc.id}:`, data);
        });

        // Check current cache
        console.log('Current event selections cache:', __eventSelectionsByToken);

        return {
          registrationsChecked: regSnap.size,
          eventSelectionsFound: esSnap.size,
          cacheSize: __eventSelectionsByToken.size
        };
      } catch (error) {
        console.error('Debug event selections error:', error);
        return { error: error.message };
      }
    };

    function escapeHtml(s) {
      return String(s).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;');
    }

    // Soft-delete: mark registration as deleted and copy to deletedUsers collection
    async function softDeleteUser(docId, data) {
      await ensureFirebase();
      const now = new Date();
      // 1) Update original document with deleted flag and metadata
      const regRef = FB.doc(FB.db, 'registrations', docId);
      await FB.updateDoc(regRef, {
        deleted: true,
        deletedAt: FB.serverTimestamp ? FB.serverTimestamp() : now,
        deletedReason: 'admin_soft_delete'
      });

      // 2) Write a copy to deletedUsers collection
      const delRef = FB.doc(FB.db, 'deletedUsers', docId);
      const copy = { ...data };
      copy.originalId = docId;
      copy.deleted = true;
      copy.deletedAt = FB.serverTimestamp ? FB.serverTimestamp() : now;
      try { delete copy.id; } catch(_) {}
      await FB.setDoc(delRef, copy);
    }
  </script>
</body>

</html>
