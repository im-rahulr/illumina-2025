<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Final Step – ILLUMINA</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/main.css?v=20240916">
  <style>
    /* WhatsApp Widget Styles */
    .whatsapp-widget {
      position: fixed;
      bottom: 20px;
      left: 20px;
      z-index: 1000;
    }

    .whatsapp-button {
      width: 60px;
      height: 60px;
      background: #25D366;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4);
      transition: all 0.3s ease;
      animation: pulse 2s infinite;
    }

    .whatsapp-button:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(37, 211, 102, 0.6);
    }

    @keyframes pulse {
      0% { box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4); }
      50% { box-shadow: 0 4px 12px rgba(37, 211, 102, 0.8), 0 0 0 10px rgba(37, 211, 102, 0.1); }
      100% { box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4); }
    }

    .whatsapp-popup {
      position: absolute;
      bottom: 80px;
      left: 0;
      width: 320px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      opacity: 0;
      visibility: hidden;
      transform: translateY(20px);
      transition: all 0.3s ease;
    }

    .whatsapp-popup.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .whatsapp-header {
      background: #075E54;
      color: white;
      padding: 16px;
      border-radius: 12px 12px 0 0;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .whatsapp-avatar .avatar-circle {
      width: 40px;
      height: 40px;
      background: #25D366;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 18px;
    }

    .whatsapp-info {
      flex: 1;
    }

    .whatsapp-name {
      font-weight: bold;
      font-size: 16px;
    }

    .whatsapp-status {
      font-size: 12px;
      opacity: 0.8;
    }

    .whatsapp-close {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .whatsapp-messages {
      padding: 16px;
      max-height: 200px;
      overflow-y: auto;
    }

    .whatsapp-message {
      margin-bottom: 12px;
    }

    .whatsapp-message.received .message-text {
      background: #f0f0f0;
      color: #333;
      padding: 8px 12px;
      border-radius: 12px 12px 12px 4px;
      font-size: 14px;
      line-height: 1.4;
    }

    .message-time {
      font-size: 11px;
      color: #999;
      margin-top: 4px;
    }

    .whatsapp-actions {
      padding: 16px;
      border-top: 1px solid #eee;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .whatsapp-action {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 10px 12px;
      text-align: left;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s ease;
    }

    .whatsapp-action:hover {
      background: #e9ecef;
      transform: translateX(2px);
    }

    /* Event Header Styles */
    .event-header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 40px;
      padding: 0 20px;
    }

    .event-logo img {
      width: 80px;
      height: auto;
    }

    .event-info {
      flex: 1;
    }

    .event-breadcrumb {
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .event-breadcrumb a {
      color: var(--primary);
      text-decoration: none;
    }

    .event-breadcrumb span {
      margin: 0 8px;
    }

    .event-title {
      font-size: clamp(24px, 4vw + 12px, 36px);
      font-weight: 800;
      margin: 0 0 8px;
      font-family: 'Poppins', system-ui, sans-serif;
    }

    .event-subtitle {
      color: var(--muted);
      font-size: 16px;
      margin: 0;
    }

    /* WhatsApp Helper Message */
    .whatsapp-helper-message {
      position: fixed;
      bottom: 100px;
      left: 20px;
      z-index: 999;
      opacity: 0;
      transform: translateX(-100px);
      animation: slideInHelper 0.5s ease-out 2s forwards;
    }

    @keyframes slideInHelper {
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .helper-bubble {
      background: white;
      padding: 12px 16px;
      border-radius: 12px 12px 12px 4px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      position: relative;
      max-width: 250px;
      animation: bounce 0.5s ease-out 2.5s;
    }

    .helper-bubble::before {
      content: '';
      position: absolute;
      bottom: 8px;
      left: -8px;
      width: 0;
      height: 0;
      border-style: solid;
      border-width: 0 8px 8px 0;
      border-color: transparent white transparent transparent;
    }

    .helper-text {
      color: #333;
      font-size: 14px;
      line-height: 1.4;
      margin-right: 20px;
    }

    .helper-close {
      position: absolute;
      top: 4px;
      right: 8px;
      background: none;
      border: none;
      color: #999;
      font-size: 16px;
      cursor: pointer;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-10px); }
      60% { transform: translateY(-5px); }
    }

    .whatsapp-helper-message.hidden {
      display: none;
    }

    @media (max-width: 768px) {
      .whatsapp-popup {
        width: 280px;
      }
      
      .helper-bubble {
        max-width: 200px;
      }

      .event-header {
        flex-direction: column;
        text-align: center;
        gap: 16px;
      }

      .event-logo img {
        width: 60px;
      }

      /* Modal responsive styles */
      .modal-card div[style*="grid-template-columns: 1fr 1fr"] {
        grid-template-columns: 1fr !important;
        gap: 16px !important;
      }
      
      /* Ensure modal fits on small screens */
      @media (max-height: 700px) {
        .modal-card.success {
          max-height: 85vh !important;
          padding: 16px !important;
        }
        
        #tokenTitle {
          font-size: 22px !important;
          margin-bottom: 8px !important;
        }
        
        #modalUserName {
          font-size: 16px !important;
          margin-bottom: 8px !important;
        }
        
        #modalToken {
          font-size: 28px !important;
          margin-bottom: 12px !important;
        }
      }
    }
  </style>
  <meta name="description" content="Complete your ILLUMINA registration by selecting payment method.">
  <meta property="og:site_name" content="ILLUMINA">
  <meta property="og:type" content="website">
  <meta property="og:title" content="Final Step • ILLUMINA">
  <meta property="og:description" content="Complete your ILLUMINA registration by selecting payment method.">
  <meta property="og:url" content="https://lac-chess.netlify.app/success.html">
  <meta property="og:image" content="https://lac-chess.netlify.app/images/og-image.jpg">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Final Step • ILLUMINA">
  <meta name="twitter:description" content="Complete your ILLUMINA registration by selecting payment method.">
  <meta name="twitter:image" content="https://lac-chess.netlify.app/images/og-image.jpg">
</head>
<body>
  <main class="container" role="main">
    <header class="event-header">
      <div class="event-logo">
        <a href="../index.html"><img src="images/lowrylogo.png" alt="ILLUMINA Logo"></a>
      </div>
      <div class="event-info">
        <div class="event-breadcrumb">
          <a href="../index.html">ILLUMINA</a> <span>/</span> <span>Registration</span>
        </div>
        <h1 class="event-title">Final Step</h1>
        <p class="event-subtitle" id="personalGreeting">Hey, [Name]!</p>
      </div>
    </header>

    <div style="max-width: 560px; margin: 0 auto; padding: 0 1rem;">

      <div style="display: grid; gap: 1rem;">
        <button id="btnOnSpot" class="btn btn-primary" type="button" style="width: 100%; font-weight: 700; padding: 16px; font-size: 16px;">
          Pay on Spot (recommended)
        </button>
        <button id="btnOnline" class="btn btn-secondary" type="button" style="width: 100%; font-weight: 600; padding: 14px; font-size: 16px;">
          Pay Online Now
        </button>
        <div class="helper" style="text-align: center; margin-top: 8px;">
          Choose your preferred payment option to continue
        </div>

        <div id="tokenWrap" class="stat-badge" style="display:none; justify-self:center; text-align: center; padding: 20px; background: var(--surface); border: 1px solid var(--line); border-radius: 12px; margin-top: 16px;">
          <div id="chosenText" style="font-size: 14px; color: var(--muted); margin-bottom: 8px;"></div>
          <div style="font-size: 24px; font-weight: 700; color: var(--primary); margin-bottom: 16px;">
            Token No: <span id="token"></span>
          </div>
          <button id="downloadTicket" class="btn btn-secondary" type="button" style="width: 100%; margin-top: 8px;">
            📥 Download Ticket
          </button>
        </div>

        <div class="helper" id="helperText"></div>
      </div>
    </div>
  </main>

  <footer class="footer" role="contentinfo">
    <small>Designed by <a class="login-link" href="https://codecraft-team.netlify.app/" target="_blank" rel="noopener">CodeCraft</a></small>
  </footer>

  <!-- WhatsApp Chat Widget -->
  <div id="whatsappWidget" class="whatsapp-widget">
    <div class="whatsapp-button" id="whatsappBtn">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.465 3.516"/>
      </svg>
    </div>
    <div class="whatsapp-popup" id="whatsappPopup">
      <div class="whatsapp-header">
        <div class="whatsapp-avatar">
          <div class="avatar-circle">V</div>
        </div>
        <div class="whatsapp-info">
          <div class="whatsapp-name">Vishal</div>
          <div class="whatsapp-status">Online • Support Team</div>
        </div>
        <button class="whatsapp-close" id="whatsappClose">×</button>
      </div>
      <div class="whatsapp-messages">
        <div class="whatsapp-message received">
          <div class="message-text">Congratulations! 🎉<br>Need help with your ILLUMINA registration?</div>
          <div class="message-time">Just now</div>
        </div>
      </div>
      <div class="whatsapp-actions">
        <button class="whatsapp-action" id="tokenHelpBtn">
          🎫 Help with Token Number
        </button>
        <button class="whatsapp-action" data-message="Hi! I need help with payment for ILLUMINA">
          💳 Payment Support
        </button>
        <button class="whatsapp-action" data-message="Hello! I have questions about ILLUMINA event details">
          📅 Event Information
        </button>
        <button class="whatsapp-action" data-message="Hi! I need general help regarding ILLUMINA">
          ❓ General Help
        </button>
      </div>
    </div>
  </div>

  <!-- Navigation guard to prevent going back to events selection after submission -->
  <script>
    (function(){
      try {
        // Push a new state so the first Back stays on this page
        history.pushState(null, '', location.href);
        window.addEventListener('popstate', function(){
          // If submission lock exists, keep the user on success page
          const locked = sessionStorage.getItem('events_submitted_token');
          if (locked) {
            history.pushState(null, '', location.href);
          }
        });
      } catch (e) { /* no-op */ }
    })();
  </script>

  <!-- WhatsApp Helper Message -->
  <div id="whatsappHelperMessage" class="whatsapp-helper-message">
    <div class="helper-bubble">
      <div class="helper-text">Hi! I'm Vishal 👋 Can I help you with anything?</div>
      <div class="helper-close" id="helperClose">×</div>
    </div>
  </div>

  <!-- Page Loader Overlay -->
  <div id="pageLoader" class="page-loader" aria-live="polite" aria-busy="false">
    <div class="spinner-standalone" aria-hidden="true"></div>
    <div id="loaderText" class="loader-text">Redirecting to payment...</div>
  </div>

  <!-- Success Modal with Token Display -->
  <div id="tokenModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="tokenTitle">
    <div class="modal-card success" style="max-width: 480px; width: 90vw; max-height: 90vh; overflow-y: auto;">
      <div id="tokenTitle" class="modal-title" style="font-size: 28px; margin-bottom: 12px;">🎉 Thank you for registering for ILLUMINA 2K25!</div>
      <div id="modalUserName" class="modal-text" style="font-size: 18px; font-weight: 500; margin-bottom: 12px; color: var(--muted);">Welcome, [Name]!</div>
      <div class="modal-text" style="font-size: 16px; font-weight: 500; margin-bottom: 24px; color: var(--primary);">Event Date: September 25, 2025</div>
      
      <div style="background: var(--surface); border: 2px solid var(--primary); border-radius: 12px; padding: 16px; margin: 16px 0; text-align: center;">
        <div style="font-size: 12px; color: var(--muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 1px;">Token Number</div>
        <div id="modalToken" style="font-size: 32px; font-weight: 700; color: var(--primary); letter-spacing: 2px; margin-bottom: 16px;">---</div>
        
        <!-- QR Code Section -->
        <div style="border-top: 1px solid var(--line); padding-top: 16px;">
          <div style="font-size: 12px; color: var(--muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;">QR Code</div>
          <div id="qrCodeContainer" style="display: flex; justify-content: center; align-items: center; background: #fff; border-radius: 6px; padding: 8px;">
            <canvas id="modalQRCanvas"></canvas>
          </div>
        </div>
      </div>
      
      <div class="modal-text" style="color: var(--muted); font-size: 13px; margin-bottom: 16px; text-align: center;">Present this token and QR code at the venue</div>
      
      <button id="downloadTicketModal" class="btn btn-primary" type="button" style="width: 100%; padding: 12px; font-weight: 600;">
        📥 Download RSVP
      </button>
    </div>
  </div>

  <script type="module">
    import { db } from './firebase-config.js';
    import { collection, doc, setDoc, serverTimestamp, query, where, limit, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    import QRCode from 'https://cdn.jsdelivr.net/npm/qrcode@1.5.3/+esm';

    (function(){
      const token = sessionStorage.getItem('lastToken');
      const name = sessionStorage.getItem('lastName') || '';
      
      // Set personalized greeting
      const greeting = document.getElementById('personalGreeting');
      if (name && greeting) {
        greeting.textContent = `Hey, ${name}!`;
      }
      const tokenWrap = document.getElementById('tokenWrap');
      const tokenEl = document.getElementById('token');
      const chosenText = document.getElementById('chosenText');
      const helper = document.getElementById('helperText');
      const btnOnSpot = document.getElementById('btnOnSpot');
      const btnOnline = document.getElementById('btnOnline');
      const tokenModal = document.getElementById('tokenModal');
      const modalToken = document.getElementById('modalToken');
      const pageLoader = document.getElementById('pageLoader');
      const loaderText = document.getElementById('loaderText');

      function showLoader(message){
        if (loaderText) loaderText.textContent = message || 'Loading…';
        if (pageLoader) {
          pageLoader.classList.add('show');
          pageLoader.setAttribute('aria-busy', 'true');
        }
      }
      function hideLoader(){
        if (pageLoader) {
          pageLoader.classList.remove('show');
          pageLoader.setAttribute('aria-busy', 'false');
        }
      }

      if (!token) {
        console.error('No token found in sessionStorage');
        helper.textContent = 'Your session has expired or token was not found. Please register again.';
        helper.style.color = '#ff6b6b';
        btnOnSpot.disabled = true;
        if (btnOnline) btnOnline.style.pointerEvents = 'none';
        return;
      }
      
      console.log('Token found:', token);
      console.log('Name found:', name);

      // Don't show token modal immediately - wait for payment selection
      modalToken.textContent = token;

      // Add download functionality to modal button
      document.getElementById('downloadTicketModal').addEventListener('click', async () => {
        const btn = document.getElementById('downloadTicketModal');
        const originalText = btn.textContent;
        
        try {
          btn.textContent = '⏳ Generating...';
          btn.disabled = true;
          
          await generateTicket(token, name, 'onspot');
          await trackDownload(token, name, 'onspot');
          
          btn.textContent = '✅ RSVP Saved';
          btn.style.background = '#28a745';
          
          setTimeout(() => {
            btn.textContent = originalText;
            btn.style.background = '';
            btn.disabled = false;
          }, 3000);
          
        } catch (error) {
          btn.textContent = '❌ Error - Try Again';
          btn.style.background = '#dc3545';
          setTimeout(() => {
            btn.textContent = originalText;
            btn.style.background = '';
            btn.disabled = false;
          }, 3000);
        }
      });



      // Generate a real QR code canvas using QRCode library
      async function generateQRCode(text, size = 120) {
        const canvas = document.createElement('canvas');
        // Encode meaningful verification payload
        const payload = JSON.stringify({
          type: 'ILLUMINA_ticket',
          token: text,
          name: sessionStorage.getItem('lastName') || '',
          event: 'ILLUMINA 2K25',
          date: 'September 25, 2025',
          venue: 'Lowry Adventist College, Bangalore',
          ts: Date.now()
        });
        await QRCode.toCanvas(canvas, payload, {
          width: size,
          margin: 0,
          errorCorrectionLevel: 'M',
          color: { dark: '#000000', light: '#FFFFFF' }
        });
        return canvas;
      }

      // Generate QR code for modal display
      async function generateModalQRCode(tokenNo, userName) {
        try {
          const canvas = document.getElementById('modalQRCanvas');
          if (!canvas) return;
          
          // Set canvas size for modal display (smaller for better fit)
          canvas.width = 120;
          canvas.height = 120;
          
          // Encode meaningful verification payload
          const payload = JSON.stringify({
            type: 'ILLUMINA_ticket',
            token: tokenNo,
            name: userName,
            event: 'ILLUMINA 2K25',
            date: 'September 25, 2025',
            venue: 'Lowry Adventist College, Bangalore',
            ts: Date.now()
          });
          
          await QRCode.toCanvas(canvas, payload, {
            width: 120,
            margin: 0,
            errorCorrectionLevel: 'M',
            color: { dark: '#000000', light: '#FFFFFF' }  // Black QR code
          });
          
          console.log('Modal QR code generated successfully');
        } catch (error) {
          console.error('Failed to generate modal QR code:', error);
          // Fallback: show error message
          const canvas = document.getElementById('modalQRCanvas');
          if (canvas) {
            const ctx = canvas.getContext('2d');
            canvas.width = 120;
            canvas.height = 120;
            ctx.fillStyle = '#f0f0f0';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#666';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('QR Error', canvas.width/2, canvas.height/2);
          }
        }
      }

      // Function to track RSVP download
      async function trackDownload(tokenNo, userName, mode) {
        try {
          console.log('Tracking RSVP download for token:', tokenNo);
          
          // Save download record to Firebase
          const downloadRef = doc(collection(db, 'rsvpDownloads'));
          await setDoc(downloadRef, {
            tokenNo: tokenNo,
            username: userName,
            paymentMode: mode,
            downloadedAt: serverTimestamp(),
            downloadType: 'user_download'
          });
          
          // Update registration record with download status
          const q = query(collection(db, 'registrations'), where('shortId', '==', tokenNo), limit(1));
          const snap = await getDocs(q);
          
          if (!snap.empty) {
            const docRef = snap.docs[0].ref;
            await updateDoc(docRef, {
              rsvpDownloaded: true,
              rsvpDownloadedAt: serverTimestamp()
            });
            console.log('Registration updated with download status');
          }
          
          console.log('RSVP download tracked successfully');
        } catch (err) {
          console.error('Failed to track RSVP download:', err);
        }
      }

      // Function to generate and download professional ticket
      async function generateTicket(tokenNo, userName, mode) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // Set canvas size
        canvas.width = 800;
        canvas.height = 600;
        
        // Background gradient
        const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
        gradient.addColorStop(0, '#0b0b0b');
        gradient.addColorStop(1, '#262524');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Border
        ctx.strokeStyle = '#7bbf44';
        ctx.lineWidth = 4;
        ctx.strokeRect(20, 20, canvas.width - 40, canvas.height - 40);
        
        // Header section
        ctx.fillStyle = '#7bbf44';
        ctx.fillRect(40, 40, canvas.width - 80, 80);
        
        // Title
        ctx.fillStyle = '#ffffff';
        ctx.font = 'bold 36px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('ILLUMINA 2K25', canvas.width / 2, 90);
        
        // Subtitle
        ctx.font = '18px Arial';
        ctx.fillStyle = '#B3B3B3';
        ctx.fillText('Lowry Adventist College, Bangalore', canvas.width / 2, 160);
        
        // Event details
        ctx.font = 'bold 24px Arial';
        ctx.fillStyle = '#ffffff';
        ctx.fillText('REGISTRATION TICKET', canvas.width / 2, 220);
        
        // Token number (large and prominent)
        ctx.font = 'bold 48px Arial';
        ctx.fillStyle = '#7bbf44';
        ctx.fillText(`TOKEN: ${tokenNo}`, canvas.width / 2, 300);
        
        // User details
        ctx.font = '20px Arial';
        ctx.fillStyle = '#ffffff';
        ctx.fillText(`Name: ${userName}`, canvas.width / 2, 360);
        
        // Payment mode
        ctx.font = '18px Arial';
        ctx.fillStyle = '#B3B3B3';
        ctx.fillText(`Payment Mode: ${mode === 'onspot' ? 'Pay on Spot' : 'Online Payment'}`, canvas.width / 2, 400);
        
        // Event date (more prominent)
        ctx.font = 'bold 20px Arial';
        ctx.fillStyle = '#7bbf44';
        ctx.fillText('Event Date: September 25, 2025', canvas.width / 2, 430);
        
        // Footer
        ctx.font = '14px Arial';
        ctx.fillStyle = '#7bbf44';
        ctx.fillText('Please present this ticket at the venue', canvas.width / 2, 480);
        
        // Generate and add QR code (scannable but compact)
        const qrCanvas = await generateQRCode(tokenNo, 120);
        ctx.drawImage(qrCanvas, canvas.width - 160, canvas.height - 160, 120, 120);
        
        // QR code label
        ctx.font = '12px Arial';
        ctx.fillStyle = '#B3B3B3';
        ctx.textAlign = 'center';
        ctx.fillText('Scan for verification', canvas.width - 100, canvas.height - 20);
        
        // Download the image with proper MIME type and error handling
        try {
          const dataURL = canvas.toDataURL('image/png', 1.0);
          const link = document.createElement('a');
          link.download = `ILLUMINA-2K25-ticket-${tokenNo}.png`;
          link.href = dataURL;
          
          // Ensure the link is added to DOM for better browser compatibility
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          // Clean up the data URL
          setTimeout(() => {
            URL.revokeObjectURL(dataURL);
          }, 100);
          
          console.log('Ticket download initiated successfully');
        } catch (error) {
          console.error('Failed to download ticket:', error);
          throw new Error('Download failed. Please try again.');
        }
      }



      async function reveal(mode){
        console.log('reveal() called with mode:', mode);
        console.log('token:', token, 'name:', name);
        
        chosenText.textContent = mode === 'onspot' ? 'Mode: Pay on Spot' : 'Mode: Online Payment';
        tokenEl.textContent = token;
        tokenWrap.style.display = '';

        // Show popup only for Pay on Spot
        if (mode === 'onspot') {
          // Update modal with user name
          const modalUserName = document.getElementById('modalUserName');
          modalUserName.textContent = `Welcome, ${name}!`;
          
          // Generate QR code automatically
          await generateModalQRCode(token, name);
          
          // Show the modal
          tokenModal.classList.add('show');
        }

        // Add download ticket functionality
        const downloadBtn = document.getElementById('downloadTicket');
        downloadBtn.addEventListener('click', async () => {
          const originalText = downloadBtn.textContent;
          
          try {
            downloadBtn.textContent = '⏳ Generating...';
            downloadBtn.disabled = true;
            
            await generateTicket(token, name, mode);
            await trackDownload(token, name, mode);
            
            downloadBtn.textContent = '✅ RSVP Saved';
            downloadBtn.style.background = '#28a745';
            
            setTimeout(() => {
              downloadBtn.textContent = originalText;
              downloadBtn.style.background = '';
              downloadBtn.disabled = false;
            }, 3000);
            
          } catch (error) {
            downloadBtn.textContent = '❌ Error - Try Again';
            downloadBtn.style.background = '#dc3545';
            setTimeout(() => {
              downloadBtn.textContent = originalText;
              downloadBtn.style.background = '';
              downloadBtn.disabled = false;
            }, 3000);
          }
        });

        // Save payment/mode selection to Firebase and update registration record
        try {
          console.log('Attempting to save payment mode to Firebase...');
          const paymentRef = doc(collection(db, 'payments'));
          await setDoc(paymentRef, {
            tokenNo: token,
            username: name,
            mode: mode,
            createdAt: serverTimestamp()
          });
          console.log('Payment record saved successfully');
          
          // Also update the registration record with payment mode
          console.log('Looking for registration with shortId:', token);
          const q = query(collection(db, 'registrations'), where('shortId', '==', token), limit(1));
          const snap = await getDocs(q);
          console.log('Query result:', snap.size, 'documents found');
          
          if (!snap.empty) {
            const docRef = snap.docs[0].ref;
            console.log('Updating registration document with paymentMode:', mode);
            await updateDoc(docRef, {
              paymentMode: mode
            });
            console.log('Registration updated successfully with paymentMode:', mode);
          } else {
            console.error('No registration found with shortId:', token);
          }
        } catch (err) {
          console.error('Failed to save payment mode:', err);
        }
      }

      btnOnSpot.addEventListener('click', () => {
        console.log('Pay on Spot button clicked');
        reveal('onspot');
      });
      if (btnOnline) {
        btnOnline.addEventListener('click', async (e) => {
          // Prevent default navigation so we can save the selection first
          e.preventDefault();
          
          // Show loading animation immediately with better messaging
          showLoader('Preparing payment page...');
          
          // Update button state to show it's loading
          btnOnline.style.opacity = '0.7';
          btnOnline.style.pointerEvents = 'none';
          btnOnline.innerHTML = '⏳ Loading...';
          
          try {
            await reveal('online');
            
            // Store payment context for secure payment flow
            sessionStorage.setItem('payment_user_context', JSON.stringify({
              token: token,
              name: name,
              timestamp: new Date().toISOString(),
              amount: '250',
              purpose: 'ILLUMINA Registration Fee'
            }));
            
            // Update loader message
            if (loaderText) loaderText.textContent = 'Redirecting to payment...';
            
            // Add a delay to show the loading animation
            setTimeout(() => {
              window.location.href = 'payment.html';
            }, 1200);
            
          } catch (error) {
            console.error('Error preparing payment:', error);
            hideLoader();
            
            // Reset button state
            btnOnline.style.opacity = '';
            btnOnline.style.pointerEvents = '';
            btnOnline.innerHTML = 'Pay Online Now';
            
            alert('Error preparing payment. Please try again.');
          }
        });
      }

      // WhatsApp Widget Functionality
      const whatsappBtn = document.getElementById('whatsappBtn');
      const whatsappPopup = document.getElementById('whatsappPopup');
      const whatsappClose = document.getElementById('whatsappClose');
      const whatsappActions = document.querySelectorAll('.whatsapp-action');
      const tokenHelpBtn = document.getElementById('tokenHelpBtn');
      const helperMessage = document.getElementById('whatsappHelperMessage');
      const helperClose = document.getElementById('helperClose');
      const whatsappNumber = '7349321463'; // Support number

      // Direct WhatsApp redirect
      whatsappBtn.addEventListener('click', () => {
        const message = `Hello! I need help with my ILLUMINA registration.

My Details:
• Name: ${name}
• Token Number: ${token}
• Issue: [Please describe your issue]

Thank you!`;
        const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
        
        // Hide helper message when WhatsApp is opened
        if (helperMessage) {
          helperMessage.classList.add('hidden');
        }
      });

      // Close popup
      whatsappClose.addEventListener('click', () => {
        whatsappPopup.classList.remove('show');
      });

      // Close popup when clicking outside
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.whatsapp-widget')) {
          whatsappPopup.classList.remove('show');
        }
      });

      // Handle token help button (personalized message)
      if (tokenHelpBtn) {
        tokenHelpBtn.addEventListener('click', () => {
          const token = sessionStorage.getItem('lastToken') || 'N/A';
          const name = sessionStorage.getItem('lastName') || '';
          const message = `Hello! I need help with my ILLUMINA registration.

My Details:
• Name: ${name}
• Token Number: ${token}
• Issue: [Please describe your issue]

Thank you!`;
          const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;
          window.open(whatsappUrl, '_blank');
          whatsappPopup.classList.remove('show');
        });
      }

      // Handle other action buttons
      whatsappActions.forEach(action => {
        if (action.id !== 'tokenHelpBtn') {
          action.addEventListener('click', () => {
            const message = action.getAttribute('data-message');
            const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            whatsappPopup.classList.remove('show');
          });
        }
      });

      // Close helper message
      if (helperClose) {
        helperClose.addEventListener('click', () => {
          helperMessage.classList.add('hidden');
        });
      }

      // Auto-hide helper message after 8 seconds
      setTimeout(() => {
        if (helperMessage && !helperMessage.classList.contains('hidden')) {
          helperMessage.classList.add('hidden');
        }
      }, 8000);

      // Click helper message to open WhatsApp
      if (helperMessage) {
        helperMessage.addEventListener('click', (e) => {
          if (e.target !== helperClose) {
            whatsappPopup.classList.add('show');
            helperMessage.classList.add('hidden');
          }
        });
      }
    })();
  </script>
</body>
</html>
